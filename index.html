<!DOCTYPE html>
<meta charset="utf-8">
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<!-- I recommend you host this file on your own, since this will change without warning -->
<script src="http://datamaps.github.io/scripts/datamaps.world.min.js?v=1"></script>
<h2 align="center">Visualization of Terrorist Attacks 1970-2014</h2>
<div id="container" style="position: center; width: 100%; height: 800px;"></div>


<script>
    //basic map config with custom fills, mercator projection

    //get component of hex
    function componentToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
    }
    //convert rgb to hex value
    function rgbToHex(r, g, b) {
        return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }



    var map = new Datamap({
        scope: 'world',
        element: document.getElementById('container'),
        projection: 'mercator',
        highlightOnHover: false,
        popupOnHover: false,
        geographyConfig: {
            highlightOnHover: false
            },
        fills: {
            defaultFill: 'rgba(242,242,242,1)',
            lt50: 'rgba(255,0,0,0.1)',
            gt50:'rgba(255,0,0,1)'
        },
        bubblesConfig: {
            borderWidth: 2,
            borderOpacity: 0.5,
            popupOnHover: false,
            radius: null,
            fillOpacity: 1,
            animate: false,
            highlightOnHover: false,
            exitDelay: 500,
            key: JSON.stringify
        },
        dataType:'csv'
    });
    var terror;
    var countries = Datamap.prototype.worldTopo.objects.world.geometries;
    d3.csv("terror_reduced.csv",function(data){
        data.forEach(function(d){
            d.latitude = +d.latitude;
            d.longitude = +d.longitude;
            d.year = +d.year;
            d.casualties = +d.casualties;
        });
        var terror_cases = [];
        var count = 0;
        var currPos = 0;
        var year = 1970;
        var currPosInYearArray = 0;
        var yearLength = 0;
        var rgbCountries = {};

        draw();

        function draw() {
            terror_cases = [];
            //for each year
            if (count == 0){
                var allCases = [];
                //get the array of the same year
                for (let i = currPos; i < data.length; i++){
                    if (data[i].year == year){
                        allCases.push(data[i]);
                        currPos = i;

                        //check if the country is in the drawing list
                        if (!(data[i].country in rgbCountries)){
                            rgbCountries[data[i].country] = [242,242,242];

                        }
                        else{
                            var newColor = rgbCountries[data[i].country];
                            newColor[0] = Math.max(newColor[0]  - 0.7,0);
                            newColor[1] = Math.max(newColor[1]  - 0.7,0);
                            newColor[2] = Math.max(newColor[2]  - 0.7,0);
                        }
                    }
                }
                //increase the year
                year += 1;
                //get length of array
                yearLength = allCases.length;
//                yearLength = Math.round(yearLength / 4);
                currPosInYearArray = 0;
            }

            // 1 year every 2 second, and animate 1/4 of a year every 1/2 second
            count += 1;
            count = count % 4;

            //add the terror cases to the list to draw
            for (let i  = 0; i < yearLength; i ++) {
                currPosInYearArray += 1;
                terror_cases.push({
                    radius: Math.min(data[currPosInYearArray].casualties / 6 + 10,40),
                    latitude: data[currPosInYearArray].latitude,
                    longitude: data[currPosInYearArray].longitude,
                    fillKey: 'gt50'
                });
            }
            console.log(year);

            //List of countries to change color
            var countries = {};
            for (let aKey in rgbCountries){
                var red = Math.round(rgbCountries[aKey][0]);
                var green = Math.round(rgbCountries[aKey][1]);
                var blue = Math.round(rgbCountries[aKey][2]);
                countries[aKey] = rgbToHex(red,green,blue);
            }

            //update the map
            map.bubbles(terror_cases);
            map.updateChoropleth(countries);

            // stop when reach the end of the file
            if (year <= 2014) {window.setTimeout(draw, 400)}
            else{
                map.bubbles([]);
            };
        }
    });
</script>
</body>