---
title: "terrorist_vis"
author: "team 404 not found"
date: "April 27, 2016"
output: html_document
includes:
      in_header: "library.html"
---

<!-- I recommend you host this file on your own, since this will change without warning -->
<style>
    #year{
        font-family: 'Ropa Sans', sans-serif;
        font-size: 45px;
        margin-top: 50px;
        color: darkred;
    }
    #name
    {
        font-family: 'Roboto Condensed', sans-serif;
        margin-top: 50px;
        font-size: 40px;
    }
    #container{
        display: -webkit-box;
        display: -moz-box;
        top: 250px; right: 0; bottom: 250px; left: 0;
        width: 100%;
        height:100%;
        margin: auto;
        background-color: whitesmoke;
        display: inline-block;

    }
</style>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://datamaps.github.io/scripts/datamaps.world.min.js?v=1"></script>
<h1 align="center" id = "name">TERRORIST ATTACKS AROUND THE WORLD 1970-2014</h1>
<h1 align="center" id ="year">1970</h1>
<div id="container"> </div>

<script>

    
    function componentToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
    }
    
    function rgbToHex(r, g, b) {
        return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }

    var map = new Datamap({
        scope: 'world',
        element: document.getElementById('container'),
        projection: 'mercator',
        highlightOnHover: false,
        popupOnHover: false,
        geographyConfig: {
            highlightOnHover: false
            },
        fills: {
            defaultFill: 'rgba(222,222,222,1)',
            lt50: 'rgba(255,0,0,0.1)',
            gt50:'rgba(28,28,28,0.9)'
        },
        bubblesConfig: {
            borderWidth: 1.5,
            borderOpacity: 1,
            popupOnHover: false,
            radius: null,
            fillOpacity: 1,
            animate: false,
            highlightOnHover: false,
            exitDelay: 500,
            key: JSON.stringify
        },
        dataType:'csv'
    });
    var terror;
    var countries = Datamap.prototype.worldTopo.objects.world.geometries;
    d3.csv("terror_reduced.csv",function(data){
        data.forEach(function(d){
            d.latitude = +d.latitude;
            d.longitude = +d.longitude;
            d.year = +d.year;
            d.casualties = +d.casualties;
        });
        var terror_cases = [];
        var count = 0;
        var currPos = 0;
        var year = 1969;
        var currPosInYearArray = 0;
        var yearLength = 0;
        var rgbCountries = {};

        draw();

        function draw() {
            terror_cases = [];
            //for each year
            if (count == 0){
                //increase the year
                year += 1;
                console.log(year);
                var allCases = [];
                //get the array of the same year
                for (let i = currPos; i < data.length; i++){
                    if (data[i].year == year){
                        allCases.push(data[i]);
                        currPos = i;

                        //check if the country is in the drawing list
                        if (!(data[i].country in rgbCountries)){
                            rgbCountries[data[i].country] = [222,222,222];

                        }
                        else{
                            var newColor = rgbCountries[data[i].country];
                            newColor[0] = Math.max(newColor[0]  - 0.7,0);
                            newColor[1] = Math.max(newColor[1]  - 0.7,0);
                            newColor[2] = Math.max(newColor[2]  - 0.7,0);
                        }
                    }
                }

                document.getElementById('year').innerHTML = year.toString();
                //get length of array
                yearLength = allCases.length;
//                yearLength = Math.round(yearLength / 4);
                currPosInYearArray = 0;
            }

            // 1 year every 2 second, and animate 1/4 of a year every 1/2 second
            count += 1;
            count = count % 4;

            //add the terror cases to the list to draw
            for (let i  = 0; i < yearLength; i ++) {
                currPosInYearArray += 1;
                terror_cases.push({
                    radius: Math.min(data[currPosInYearArray].casualties / 5 + 7,40),
                    latitude: data[currPosInYearArray].latitude,
                    longitude: data[currPosInYearArray].longitude,
                    fillKey: 'gt50'
                });
            }
            console.log(year);

            //List of countries to change color
            var countries = {};
            for (let aKey in rgbCountries){
                var red = Math.round(rgbCountries[aKey][0]);
                var green = Math.round(rgbCountries[aKey][1]);
                var blue = Math.round(rgbCountries[aKey][2]);
                countries[aKey] = rgbToHex(red,green,blue);
            }

            //update the map
            map.bubbles(terror_cases);
            map.updateChoropleth(countries);

            // stop when reach the end of the file
            if (year <= 2014) {window.setTimeout(draw, 400)}
            else{
                map.bubbles([]);
            };
        }
    });
</script>

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
summary(cars)
```

You can also embed plots, for example:

```{r, echo=FALSE}
plot(cars)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
